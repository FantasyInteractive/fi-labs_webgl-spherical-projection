/*
 * heatmap.js 1.0 -    JavaScript Heatmap Library
 *
 * Copyright (c) 2011, Patrick Wied (http://www.patrick-wied.at)
 * Dual-licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 * and the Beerware (http://en.wikipedia.org/wiki/Beerware) license.
 */(function(a){var b=function(){function a(a){var b={data:[],heatmap:a};this.max=1,this.get=function(a){return b[a]},this.set=function(a,c){b[a]=c}}function b(b){var c={radiusIn:20,radiusOut:40,element:{},canvas:{},acanvas:{},ctx:{},actx:{},visible:!0,width:0,height:0,max:!1,gradient:!1,opacity:180,premultiplyAlpha:!1,debug:!1};this.store=new a(this),this.get=function(a){return c[a]},this.set=function(a,b){c[a]=b},this.configure(b),this.init()}return a.prototype={addDataPoint:function(a,b){if(a<0||b<0)return;var c=this,d=c.get("heatmap"),e=c.get("data");e[a]||(e[a]=[]),e[a][b]||(e[a][b]=0),e[a][b]+=arguments.length<3?1:arguments[2],c.set("data",e);if(c.max<e[a][b]){c.max=e[a][b],d.get("actx").clearRect(0,0,d.get("width"),d.get("height"));for(var f in e)for(var g in e[f])d.drawAlpha(f,g,e[f][g]);return}d.drawAlpha(a,b,e[a][b])},setDataSet:function(a){var b=this,c=b.get("heatmap"),d=[],e=a.data,f=e.length;c.clear(),this.max=a.max;while(f--){var g=e[f];c.drawAlpha(g.x,g.y,g.count),d[g.x]||(d[g.x]=[]),d[g.x][g.y]||(d[g.x][g.y]=0),d[g.x][g.y]=g.count}this.set("data",d)},exportDataSet:function(){var a=this,b=a.get("data"),c=[];for(var d in b){if(d===undefined)continue;for(var e in b[d]){if(e===undefined)continue;c.push({x:parseInt(d,10),y:parseInt(e,10),count:b[d][e]})}}return{max:a.max,data:c}},generateRandomDataSet:function(a){var b=this.get("heatmap"),c=b.get("width"),d=b.get("height"),e={},f=Math.floor(Math.random()*1e3+1);e.max=f;var g=[];while(a--)g.push({x:Math.floor(Math.random()*c+1),y:Math.floor(Math.random()*d+1),count:Math.floor(Math.random()*f+1)});e.data=g,this.setDataSet(e)}},b.prototype={configure:function(a){var b=this,c,d;a.radius&&(c=a.radius,d=parseInt(c/2,10)),b.set("radiusIn",d||15),b.set("radiusOut",c||40),b.set("element",a.element instanceof Object?a.element:document.getElementById(a.element)),b.set("visible",a.visible),b.set("max",a.max||!1),b.set("gradient",a.gradient||{.45:"rgb(0,0,255)",.55:"rgb(0,255,255)",.65:"rgb(0,255,0)",.95:"yellow",1:"rgb(255,0,0)"}),b.set("opacity",parseInt(255/(100/a.opacity),10)||180),b.set("width",a.width||0),b.set("height",a.height||0),b.set("debug",a.debug)},resize:function(){var a=this.get("element"),b=this.get("canvas"),c=this.get("acanvas");b.width=c.width=a.style.width.replace(/px/,"")||this.getWidth(a),this.set("width",b.width),b.height=c.height=a.style.height.replace(/px/,"")||this.getHeight(a),this.set("height",b.height)},init:function(){var a=this,b=document.createElement("canvas"),c=document.createElement("canvas"),d=a.get("element");a.initColorPalette(),a.set("canvas",b),a.set("acanvas",c),a.resize(),b.style.position=c.style.position="absolute",b.style.top=c.style.top="0",b.style.left=c.style.left="0",b.style.zIndex=1e6,a.get("visible")||(b.style.display="none"),a.get("element").appendChild(b),a.get("debug")&&document.body.appendChild(c),a.set("ctx",b.getContext("2d")),a.set("actx",c.getContext("2d"))},initColorPalette:function(){var a=this,b=document.createElement("canvas"),c=a.get("gradient"),d,e,f;b.width="1",b.height="256",d=b.getContext("2d"),e=d.createLinearGradient(0,0,1,256),f=d.getImageData(0,0,1,1),f.data[0]=f.data[3]=64,f.data[1]=f.data[2]=0,d.putImageData(f,0,0),f=d.getImageData(0,0,1,1),a.set("premultiplyAlpha",f.data[0]<60||f.data[0]>70);for(var g in c)e.addColorStop(g,c[g]);d.fillStyle=e,d.fillRect(0,0,1,256),a.set("gradient",d.getImageData(0,0,1,256).data)},getWidth:function(a){var b=a.offsetWidth;return a.style.paddingLeft&&(b+=a.style.paddingLeft),a.style.paddingRight&&(b+=a.style.paddingRight),b},getHeight:function(a){var b=a.offsetHeight;return a.style.paddingTop&&(b+=a.style.paddingTop),a.style.paddingBottom&&(b+=a.style.paddingBottom),b},colorize:function(a,b){var c=this,d=c.get("width"),e=c.get("radiusOut"),f=c.get("height"),g=c.get("actx"),h=c.get("ctx"),i=e*2,j=c.get("premultiplyAlpha"),k=c.get("gradient"),l=c.get("opacity"),m,n,o,p,q,r;a+i>d&&(a=d-i),a<0&&(a=0),b<0&&(b=0),b+i>f&&(b=f-i),m=g.getImageData(a,b,i,i),n=m.data,o=n.length;for(var s=3;s<o;s+=4){p=n[s],q=p*4;if(!q)continue;r=p<l?p:l,n[s-3]=k[q],n[s-2]=k[q+1],n[s-1]=k[q+2],j&&(n[s-3]/=255/r,n[s-2]/=255/r,n[s-1]/=255/r),n[s]=r}m.data=n,h.putImageData(m,a,b)},drawAlpha:function(a,b,c){var d=this,e=d.get("radiusIn"),f=d.get("radiusOut"),g=d.get("actx"),h=d.get("max"),i=g.createRadialGradient(a,b,e,a,b,f),j=a-f,k=b-f,l=2*f;i.addColorStop(0,"rgba(0,0,0,"+(c?c/d.store.max:"0.1")+")"),i.addColorStop(1,"rgba(0,0,0,0)"),g.fillStyle=i,g.fillRect(j,k,l,l),d.colorize(j,k)},toggleDisplay:function(){var a=this,b=a.get("visible"),c=a.get("canvas");b?c.style.display="none":c.style.display="block",a.set("visible",!b)},getImageData:function(){return this.get("canvas").toDataURL()},clear:function(){var a=this,b=a.get("width"),c=a.get("height");a.store.set("data",[]),a.get("ctx").clearRect(0,0,b,c),a.get("actx").clearRect(0,0,b,c)},cleanup:function(){var a=this;a.get("element").removeChild(a.get("canvas"))}},{create:function(a){return new b(a)},util:{mousePosition:function(a){var b,c;a.layerX?(b=a.layerX,c=a.layerY):a.offsetX&&(b=a.offsetX,c=a.offsetY);if(typeof b=="undefined")return;return[b,c]}}}}();a.h337=a.heatmapFactory=b})(window);